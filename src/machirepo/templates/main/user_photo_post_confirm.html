{% extends "top_base.html" %}

{% block title %}æŠ•ç¨¿å†…å®¹ã®ç¢ºèª{% endblock %}

{% block content %}
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
    <style>
        /* åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠã®ã‚µã‚¤ã‚ºã‚’å®šç¾© */
    

        /* ğŸ’¡ è¿½åŠ : ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« (ç®¡ç†è€…ç”»é¢ã¨å…±é€š) ğŸ’¡ */
        .custom-div-icon {
            background-color: #e53e3e; /* èµ¤ */
            border: 3px solid #ffffff; /* ç™½ã„ç¸ */
            width: 15px; /* ã‚µã‚¤ã‚º */
            height: 15px;
            border-radius: 50%; /* å††å½¢ */
            opacity: 0.9;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }

        /* ãã®ä»–ã®æ—¢å­˜ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        
        .header-link { text-decoration: none; color: #10b981; font-weight: 600; }
        .main-content { padding-bottom: 7rem; }
        .form-group { margin-bottom: 1.5rem; }
        .app-footer { padding: 1rem 1rem; background-color: #ffffff; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1); position: sticky; bottom: 0; z-index: 100; }
        .uploaded-photo { max-width: 100%; height: auto; max-height: 300px; border-radius: 0.375rem; object-fit: cover; border: 1px solid #e5e7eb;}
    </style>

    <div class="app-container">
        <header class="app-header">
            <a href="{% url 'photo_post_create' %}" class="header-link">&lt; ä¿®æ­£ã™ã‚‹</a>
            <h2 style="font-size: 1.25rem; font-weight: 700; position: absolute; left: 50%; transform: translateX(-50%);">æŠ•ç¨¿å†…å®¹ã®ç¢ºèª</h2>
            <span style="width: 80px;"></span>
        </header>
        
        <main class="main-content">
        
            
            <div class="form-group">
                <label class="block text-gray-700 font-medium mb-1">ã‚¿ã‚¤ãƒˆãƒ«:</label>
                <p class="bg-gray-50 p-3 border border-gray-300 rounded-md whitespace-pre-wrap">{{ post_data.title|default:"(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)" }}</p>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label class="block text-gray-700 font-medium mb-1">å†™çœŸ:</label>
                <div class="photo-container">
                    {% if request.session.post_photo_data %}
                        <img src="{{ request.session.post_photo_data }}" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸ" class="uploaded-photo">
                    {% else %}
                        å†™çœŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
                    {% endif %}
                </div>
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label class="block text-gray-700 font-medium mb-1">å ´æ‰€:</label>
                
                {% if post_data.latitude and post_data.longitude %}
                    <div id="map-display"></div>
                {% else %}
                    <div style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; margin:0; line-height: 1.6;">
                        ä½ç½®æƒ…å ±ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                    </div>
                {% endif %}
                
            </div>

            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label class="block text-gray-700 font-medium mb-1">ã‚«ãƒ†ã‚´ãƒª:</label>
                <p style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; margin:0;">
                    
                    {# â˜…ã“ã“ã‚’ä¿®æ­£ã—ã¾ã—ãŸ: post_data.tags ã®ãƒ«ãƒ¼ãƒ—ã‚’å‰Šé™¤ã—ã€selected_tag ã‚’å‚ç…§ã—ã¾ã™ã€‚â˜… #}
                    {% if selected_tag %}
                        <span>{{ selected_tag.name }}</span>
                    {% elif post_data.tags is not None %}
                        {# post_data.tags ãŒ None ã§ã¯ãªãã€TagãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆï¼ˆã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼‰ #}
                        ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã«ã‚¨ãƒ©ãƒ¼
                    {% else %}
                        {# post_data.tags ãŒ None ã®å ´åˆï¼ˆé¸æŠãªã—ï¼‰ #}
                        ã‚«ãƒ†ã‚´ãƒªãªã—
                    {% endif %}
                    
                </p>
            </div>
            
            <div class="form-group" style="margin-bottom: 1.5rem;">
                <label class="block text-gray-700 font-medium mb-1">è©³ç´°:</label>
                <p style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; line-height: 1.6; margin:0;">
                    {{ post_data.comment|default:"ã‚³ãƒ¡ãƒ³ãƒˆãªã—"}}
                </p>
            </div>
        </main>
        
        <footer class="app-footer">
            <form method="post" action="{% url 'photo_post_confirm' %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-primary" style="width: 100%;">ã“ã®å†…å®¹ã§æŠ•ç¨¿ã™ã‚‹</button>
            </form>
        </footer>
    </div>
    
    {% if post_data.latitude and post_data.longitude %}
        <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
        <script>
            // ğŸ’¡ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®šç¾©
            const customIcon = L.divIcon({
                className: 'custom-div-icon', // ä¸Šã§å®šç¾©ã—ãŸCSSã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
                iconSize: [15, 15],           // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º
                iconAnchor: [7.5, 7.5],       // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒã«åˆã‚ã›ã‚‹
                popupAnchor: [0, -10]         // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®èª¿æ•´
            });

            const lat = parseFloat("{{ post_data.latitude|default:"0" }}"); 
            const lng = parseFloat("{{ post_data.longitude|default:"0" }}");
            
            // DOMContentLoadedå¾Œã«åœ°å›³ã‚’åˆæœŸåŒ–
            document.addEventListener('DOMContentLoaded', function() {
                if (lat !== 0 || lng !== 0) {
                    // åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
                    const mapContainer = document.getElementById('map-display');
                    if (mapContainer) {
                        // 1. Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
                        const map = L.map('map-display').setView([lat, lng], 16); 
                        
                        // 2. ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                        }).addTo(map);

                        // 3. ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ  - ğŸ’¡ customIconã‚’ä½¿ç”¨
                        L.marker([lat, lng], {icon: customIcon}).addTo(map)
                            .bindPopup('æŠ•ç¨¿å ´æ‰€')
                            .openPopup();
                            
                        // 4. ã‚µã‚¤ã‚ºã‚’å†è©•ä¾¡ (å¿µã®ãŸã‚)
                        setTimeout(() => { map.invalidateSize(); }, 100);
                    }
                }
            });
        </script>
    {% endif %}
{% endblock %}