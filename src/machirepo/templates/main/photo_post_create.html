{% extends 'top_base.html' %} 

{% load static %}

{% block title %}新規投稿{% endblock %} 

{% block extra_head %}
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJp3vW7l8YF6Z+T6L7z8F+J7+F7T+7+P3QvG4s="
        crossorigin=""/>
    <style>
        .map-container {
            height: 250px;
            width: 100%;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        /* forms.py で設定したクラス */
        .w-full { width: 100%; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .border { border-width: 1px; }
        .border-gray-300 { border-color: #d1d5db; }
        .rounded-lg { border-radius: 0.5rem; }
        .focus\:outline-none:focus { outline: none; }
        .focus\:ring-2:focus { --tw-ring-offset-shadow: var(--tw-ring-inset) 0 0 0 var(--tw-ring-offset-width) var(--tw-ring-offset-color); --tw-ring-shadow: var(--tw-ring-inset) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color); box-shadow: var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow, 0 0 #0000); }
        .focus\:ring-blue-500:focus { --tw-ring-color: #3b82f6; }
        .transition { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .input-style {
            /* forms.py のウィジェット設定でクラスが適用されるはずですが、念のため手動フィールドにも適用 */
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
        .textarea-style {
            /* forms.py のウィジェット設定でクラスが適用されるはずですが、念のため手動フィールドにも適用 */
            @apply w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="app-container">
        <header class="app-header">
            <!-- 'home.html' を Django の URL タグに置換 -->
            <a href="{% url 'user_home' %}" class="header-link" style="font-weight: 600; color: #10b981;">&lt; 戻る</a>
            <h2 style="font-size: 1.25rem; font-weight: 700; position: absolute; left: 50%; transform: translateX(-50%);">新規投稿</h2>
            <span style="width: 50px;"></span>
        </header>
            <!-- method, enctype, csrf_token はOK -->
        <form method="POST" enctype="multipart/form-data">
            <main class="main-content">
                {% csrf_token %}
                
                <!-- 1. 報告のタイトル (title) - これが唯一のタイトルフィールドです -->
                <div class="form-group mb-6">
                    <label for="{{ form.title.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-1">
                        {{ form.title.label }}<span class="text-red-500 ml-1">*</span>
                    </label>
                    <!-- form.title が name="title" の入力フィールドをレンダリングします -->
                    {{ form.title }}
                    {% if form.title.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.title.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            
                <!-- 2. 不具合箇所の写真 (photo) -->
                <div class="form-group">
                    <label>① 不具合箇所の写真 (必須)</label>
                    <div style="border: 2px dashed #d1d5db; border-radius: 0.375rem; padding: 2rem; text-align: center; color: #6b7280; position: relative;">
                        <!-- Django Form field for Photo -->
                        {{ form.photo }}
                        <span style="display: block; margin-top: 0.5rem;">
                            写真をアップロード
                            {% if form.photo.errors %}{{ form.photo.errors }}{% endif %}
                        </span>
                    </div>
                </div>

                <!-- 3. 場所の指定 (latitude/longitude) -->
                <div class="form-group">
                    <label>② 場所の指定 (自動取得中)</label>
                    <div id="map" class="map-container">
                        <!-- ここに Leaflet マップが表示されます -->
                    </div>
                    <p id="location-status" style="margin-top: 0.5rem; font-size: 0.875rem; color: #10b981;">
                        位置情報を取得中です...
                    </p>
                    
                    <!-- 緯度、経度、地名を保持する隠しフィールド -->
                    <input type="hidden" id="latitude" name="latitude" value="{{ default_lat }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ default_lng }}">
                    <input type="hidden" id="location_name" name="location_name" value="">
                    
                    <!-- フォームのその他の位置情報エラー表示 -->
                    {% if form.non_field_errors %}<div class="errorlist">{{ form.non_field_errors }}</div>{% endif %}
                </div>

                <!-- 4. カテゴリ (tags) -->
                <div class="form-group">
                    <label for="{{ form.tags.id_for_label }}">③ カテゴリ (必須)</label>
                    {{ form.tags }}
                    {% if form.tags.errors %}{{ form.tags.errors }}{% endif %}
                </div>
                
                <!-- 5. 詳細 (comment) -->
                <div class="form-group">
                    <label for="{{ form.comment.id_for_label }}">④ 詳細</label>
                    {{ form.comment }}
                    {% if form.comment.errors %}{{ form.comment.errors }}{% endif %}
                </div>
            </main>
                <footer class="app-footer">
                        <!-- formmethod/formenctype属性は、親の <form> タグにすでに設定されているため不要ですが、
                        このボタンがフォームの外にある可能性があるため、念のため残します。 -->
                    <button type="submit" class="btn btn-primary" style="width: 100%;" formmethod="POST" formenctype="multipart/form-data">確認画面へ</button>
                    <p id="error-manual-link" style="text-align: center; color: #ef4444; font-size: 0.875rem; margin-top: 0.5rem; display: none;">
                        位置情報の取得に失敗しました。<a href="{% url 'photo_post_location' %}" style="text-decoration: underline;">手動で入力する</a>
                    </p>
                </footer>
        </form>
        

       
    </div>
{% endblock %}

{% block extra_js %}
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20n6g9zXwYg68F9eWvX9bVb8z+qW44Y3vD3Vf+wKz9A="
        crossorigin=""></script>

    <script>
        const mapElement = document.getElementById('map');
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');
        const locationStatus = document.getElementById('location-status');
        const errorManualLink = document.getElementById('error-manual-link');
        const submitButton = document.querySelector('button[type="submit"]');

        let map, marker;

        // Leaflet マップを初期化
        function initializeMap(lat, lng) {
            // map変数がすでに初期化されている場合は、再初期化を避ける
            if (map) {
                map.remove();
            }

            map = L.map(mapElement).setView([lat, lng], 16);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            marker = L.marker([lat, lng], { draggable: true }).addTo(map);
            
            // マーカーをドラッグしたときの位置情報を更新
            marker.on('dragend', function (e) {
                const newPos = marker.getLatLng();
                updateLocation(newPos.lat, newPos.lng);
            });
            
            // マップをクリックしたとき、マーカーを移動し位置情報を更新
            map.on('click', function (e) {
                marker.setLatLng(e.latlng);
                updateLocation(e.latlng.lat, e.latlng.lng);
            });
            
            // 初回表示時にマップの位置情報を入力フィールドにセット
            updateLocation(lat, lng, '初期位置'); 
        }

        // 緯度経度を更新し、ステータスを表示する
        function updateLocation(lat, lng, statusText = 'マーカー位置') {
            latInput.value = lat;
            lngInput.value = lng;
            locationStatus.textContent = `現在地: 緯度 ${lat.toFixed(6)}, 経度 ${lng.toFixed(6)} (${statusText})`;
            locationStatus.style.color = '#10b981'; // 成功時の色
            submitButton.disabled = false; // フォーム送信を有効化
        }

        // 現在地を取得
        function getGeolocation() {
            if (!navigator.geolocation) {
                handleLocationError('お使いのブラウザは地理位置情報に対応していません。');
                return;
            }

            locationStatus.textContent = '位置情報を取得中...';
            submitButton.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    initializeMap(lat, lng);
                    updateLocation(lat, lng, 'GPSで取得');
                    errorManualLink.style.display = 'none';
                },
                (error) => {
                    // エラーコードに応じてメッセージを設定
                    let message;
                    switch (error.code) {
                        case error.PERMISSION_DENIED:
                            message = "位置情報の利用が許可されませんでした。";
                            break;
                        case error.POSITION_UNAVAILABLE:
                            message = "位置情報を取得できませんでした。";
                            break;
                        case error.TIMEOUT:
                            message = "位置情報の取得がタイムアウトしました。";
                            break;
                        default:
                            message = "位置情報の取得に失敗しました。";
                    }
                    handleLocationError(message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000, // 10秒でタイムアウト
                    maximumAge: 0
                }
            );
        }

        // 位置情報取得失敗時の処理
        function handleLocationError(message) {
            console.error('Geolocation Error:', message);
            
            // デフォルト座標でマップを初期化
            // ビューから渡された default_lat/lng を利用
            const defaultLat = parseFloat('{{ default_lat|default:"34.8333" }}'); // 34.8333 Himeji のデフォルト
            const defaultLng = parseFloat('{{ default_lng|default:"134.6833" }}'); // 134.6833

            initializeMap(defaultLat, defaultLng);
            
            // 緯度経度を 0.0 に設定し、ビューで手動入力画面へリダイレクトさせる
            latInput.value = '0.0';
            lngInput.value = '0.0';

            locationStatus.textContent = '位置情報の取得に失敗。マーカーで位置を調整するか、手動で入力してください。';
            locationStatus.style.color = '#ef4444'; // エラー時の色
            
            // 手動入力画面へのリンクを表示
            errorManualLink.style.display = 'block';
            submitButton.disabled = false; // フォーム送信は有効にする（ビュー側で手動入力へリダイレクトされるため）
        }

        window.onload = function() {
            // ページロード時に現在地を取得してマップを表示
            getGeolocation();
            
            // DjangoのSelectMultipleフィールドはデフォルトで複数選択に見えるため、単一選択に見えるように調整
            const tagsSelect = document.getElementById('{{ form.tags.id_for_label }}');
            if (tagsSelect && tagsSelect.tagName === 'SELECT') {
                tagsSelect.className = 'select-style w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-150';
            }
            // 画像入力フィールドを非表示にし、親divをクリックしたときに開く
            const photoInput = document.getElementById('{{ form.photo.id_for_label }}');
            if (photoInput) {
                photoInput.style.opacity = '0';
                photoInput.style.position = 'absolute';
                photoInput.style.top = '0';
                photoInput.style.left = '0';
                photoInput.style.width = '100%';
                photoInput.style.height = '100%';
                photoInput.style.cursor = 'pointer';
            }
        };
    </script>


    
{% endblock %}
