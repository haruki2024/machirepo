{% extends 'top_base.html' %} 

{% load static %}

{% block title %}æ–°è¦æŠ•ç¨¿{% endblock %} 

{% block extra_head %}
    {% endblock %}

{% block content %}
    <style>
        /* ğŸ’¡ CSSã‚’ã“ã“ã«ç§»å‹• */
        .map-container {
            height: 250px;
            width: 100%;
            
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            position: relative; 
            z-index: 10; 
            background-color: #f8f8f8; 
        }
        
        #map-wrapper {
            text-align: center;
        }
        
        .form-group { margin-bottom: 1.5rem; }
        .input-style, .textarea-style, select { width: 100%; padding: 0.5rem 0.75rem; border: 1px solid #d1d5db; border-radius: 0.5rem; transition: all 150ms; }
        {% comment %} .app-footer { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #ffffff; padding: 1rem; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1); z-index: 100; } {% endcomment %}
        .app-footer { padding: 1rem 1rem; background-color: #ffffff; border-top: 1px solid #e5e7eb; box-shadow: 0 -4px 6px -1px rgb(0 0 0 / 0.1), 0 -2px 4px -2px rgb(0 0 0 / 0.1); position: sticky; bottom: 0; z-index: 100; }
        .file-select-button { display: inline-block; padding: 0.5rem 1rem; margin-top: 1rem; background-color: #10b981; color: white; border-radius: 0.5rem; cursor: pointer; font-weight: 600; transition: background-color 0.15s; position: relative; overflow: hidden; }
        .file-select-button:hover { background-color: #059669; }
        .file-select-button input[type="file"] { position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; font-size: 100px; height: 100%; width: 100%; }
        .w-full { width: 100%; }

        /* ğŸ’¡ æ–°è¦è¿½åŠ : ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å…±é€šåŒ– */
        .custom-div-icon {
            background-color: #e53e3e; /* èµ¤ */
            border: 3px solid #ffffff; /* ç™½ã„ç¸ */
            width: 15px; /* ã‚µã‚¤ã‚º */
            height: 15px;
            border-radius: 50%; /* å††å½¢ */
            opacity: 0.9;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
        }
    </style>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>


    <div class="app-container" >
        <header class="app-header">
            <a href="{% url 'user_home' %}" class="header-link" style="font-weight: 600; color: #10b981;">&lt; æˆ»ã‚‹</a>
            <h2 style="font-size: 1.25rem; font-weight: 700; position: absolute; left: 50%; transform: translateX(-50%);">æ–°è¦æŠ•ç¨¿</h2>
            <span style="width: 50px;"></span>
        </header>
        
        <form method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            <main class="main-content">
                <div class="form-group">
                    <label for="{{ form.title.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-1">â‘  ã‚¿ã‚¤ãƒˆãƒ«</label>
                    {{ form.title }}
                    {% if form.title.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.title.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                
                <div class="form-group">
                    <label class="block text-lg font-medium text-gray-700 mb-1">â‘¡ ä¸å…·åˆç®‡æ‰€ã®å†™çœŸ</label>
                    <img id="photo-preview" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" style="max-width: 100%; height: auto; max-height: 400px; border-radius: 8px; object-fit: contain; border: 1px solid #ddd; margin-bottom: 1rem; display: none;">
                    <div class="photo-upload-area">
                        <label for="{{ form.photo.id_for_label }}" class="file-select-button">å†™çœŸã‚’é¸æŠ/å¤‰æ›´ã™ã‚‹
                            {{ form.photo }} 
                        </label>
                        <p id="file-name-display" style="font-size: 0.8rem; margin-top: 0.5rem; color: #495057;">ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>
                        {% if form.photo.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.photo.errors %}{{ error }}{% endfor %}</div>{% endif %}
                    </div>
                </div>

                <div class="form-group">
                    <label class="block text-lg font-medium text-gray-700 mb-1">â‘¢ å ´æ‰€ã®æŒ‡å®š</label>
                    
                    <div id="map-wrapper" style="text-align: center;"> 
                        <div id="map" class="map-container" style="display: none;"></div>
                    </div>

                    <p id="location-status" style="font-size: 0.9rem; margin-top: 0.5rem; color: #6b7280;">ä½ç½®æƒ…å ±ã‚’å–å¾—ã—ã¦ã„ã¾ã™...</p>
                    
                    <input type="hidden" id="latitude" name="latitude" value="{{ default_lat }}">
                    <input type="hidden" id="longitude" name="longitude" value="{{ default_lng }}">
                    <input type="hidden" id="location_name" name="location_name" value="">
                    
                    {% if form.non_field_errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.non_field_errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>

                <div class="form-group">
                    <label for="{{ form.tags.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-1">â‘£ ã‚«ãƒ†ã‚´ãƒª</label>
                    {{ form.tags }}
                    {% if form.tags.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.tags.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.comment.id_for_label }}" class="block text-lg font-medium text-gray-700 mb-1">â‘¤ è©³ç´°</label>
                    {{ form.comment }}
                    {% if form.comment.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.comment.errors %}{{ error }}{% endfor %}</div>{% endif %}
                </div>
            
            </main>
            <footer class="app-footer">
                <button type="submit" class="btn btn-primary" style="width: 100%;" formmethod="POST" formenctype="multipart/form-data">ç¢ºèªç”»é¢ã¸</button>
            </footer>
        </form>
        
    </div>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        
        // --- ğŸ’¡ ä¿®æ­£ãƒ»è¿½åŠ ç®‡æ‰€ï¼šã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã®å®šç¾© ---
        
        // æ—¢å­˜ã® Leaflet ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã®ä¾å­˜é–¢ä¿‚ã‚’å‰Šé™¤ï¼ˆã‚«ã‚¹ã‚¿ãƒ ã‚¢ã‚¤ã‚³ãƒ³ä½¿ç”¨ã®ãŸã‚ï¼‰
        delete L.Icon.Default.prototype._getIconUrl;

        // Leaflet ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¢ã‚¤ã‚³ãƒ³ã‚’ä½¿ã‚ãªã„ãŒã€å¿µã®ãŸã‚è¨­å®šã‚’æ®‹ã™ã“ã¨ã‚‚å¯èƒ½ã ãŒã€ã“ã“ã§ã¯ã‚«ã‚¹ã‚¿ãƒ ãƒ”ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ã€‚
        /* L.Icon.Default.mergeOptions({
            iconRetinaUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png',
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png'
        }); */
        
        // ğŸ’¡ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®šç¾©
        const customIcon = L.divIcon({
            className: 'custom-div-icon', // CSSã§å®šç¾©ã•ã‚ŒãŸèµ¤è‰²ã®å††å½¢ãƒ”ãƒ³
            iconSize: [15, 15],           // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º
            iconAnchor: [7.5, 7.5],       // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒã«åˆã‚ã›ã‚‹
            popupAnchor: [0, -10]         // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®èª¿æ•´
        });
        
        // --------------------------------------------------------
        
        // --- ğŸ’¡ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã§å¤‰æ•°ã‚’å®£è¨€ ---
        let mapInstance = null;
        let markerInstance = null;
        let geoAttemptCompleted = false; 
        let geoTimer;
        const TIMEOUT_DURATION = 5000; 
        
        // --- â‘¡ ä¸å…·åˆç®‡æ‰€ã®å†™çœŸ é–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ (å¤‰æ›´ãªã—) ---
        const photoFileName = "{{ post_data.photo_path|default:'' }}"; 
        const photoElement = document.getElementById('photo-preview');
        const fileNameDisplay = document.getElementById('file-name-display');

        if (photoFileName) {
            const MEDIA_URL_PREFIX = '/media/'; 
            const photoUrl = MEDIA_URL_PREFIX + photoFileName;
            photoElement.src = photoUrl;
            photoElement.style.display = 'block'; 
            if (fileNameDisplay) { fileNameDisplay.textContent = `âœ… éå»ã®æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å†™çœŸã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸã€‚`; }
        } else {
            photoElement.style.display = 'none';
            if (fileNameDisplay) { fileNameDisplay.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'; }
        }
        const fileInput = document.getElementById('{{ form.photo.id_for_label }}');
        if (fileInput) {
            fileInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        photoElement.src = e.target.result; 
                        photoElement.style.display = 'block';
                        if (fileNameDisplay) { fileNameDisplay.textContent = `é¸æŠä¸­ã®ãƒ•ã‚¡ã‚¤ãƒ«: ${file.name} (ã‚µã‚¤ã‚º: ${(file.size / 1024 / 1024).toFixed(2)} MB)`; }
                    };
                    reader.readAsDataURL(file); 
                } else {
                    photoElement.style.display = 'none';
                    photoElement.src = '';
                    if (fileNameDisplay) { fileNameDisplay.textContent = 'ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚'; }
                }
            });
        }
    
        // --- â‘¢ å ´æ‰€ã®æŒ‡å®š é–¢é€£ãƒ­ã‚¸ãƒƒã‚¯ ---
        
        function initializeMap(lat, lng) {
            const mapWrapper = document.getElementById('map-wrapper');
            const oldMapDiv = document.getElementById('map'); 
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const statusMessage = document.getElementById('location-status');
            
            // æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ç ´æ£„ (é‡è¤‡é˜²æ­¢)
            if (mapInstance) {
                mapInstance.remove(); 
                mapInstance = null;
            }

            // å¤ã„ #map è¦ç´ ã‚’DOMã‹ã‚‰å®Œå…¨ã«å‰Šé™¤ (æ®‹éª¸é˜²æ­¢)
            if (oldMapDiv && oldMapDiv.parentNode === mapWrapper) {
                oldMapDiv.remove(); 
            }
            
            // æ–°ã—ã„ #map è¦ç´ ã‚’ä½œæˆã—ã€ãƒ©ãƒƒãƒ‘ãƒ¼ã«è¿½åŠ  (å†ç”Ÿæˆ)
            const newMapDiv = document.createElement('div');
            newMapDiv.id = 'map';
            newMapDiv.className = 'map-container'; 
            newMapDiv.style.display = 'block'; 
            mapWrapper.appendChild(newMapDiv); 

            // ãƒãƒƒãƒ—ã®åˆæœŸåŒ–
            mapInstance = L.map('map').setView([lat, lng], 16); 
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(mapInstance);

            // ãƒãƒ¼ã‚«ãƒ¼ã®è¿½åŠ  - ğŸ’¡ customIconã‚’ä½¿ç”¨
            markerInstance = L.marker([lat, lng], {icon: customIcon}).addTo(mapInstance)
                .bindPopup('æŠ•ç¨¿å ´æ‰€')
                .openPopup();
                
            // ãƒãƒƒãƒ—ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            mapInstance.on('click', function(e) {
                const newLat = e.latlng.lat;
                const newLng = e.latlng.lng;

                if (markerInstance) {
                    mapInstance.removeLayer(markerInstance);
                }
                
                // æ–°ã—ã„ãƒãƒ¼ã‚«ãƒ¼ã®ä½œæˆ - ğŸ’¡ customIconã‚’ä½¿ç”¨
                markerInstance = L.marker([newLat, newLng], {icon: customIcon}).addTo(mapInstance)
                    .bindPopup('æ–°ã—ã„æŠ•ç¨¿å ´æ‰€')
                    .openPopup();
                    
                latitudeInput.value = newLat;
                longitudeInput.value = newLng;
                statusMessage.textContent = `æŠ•ç¨¿å ´æ‰€ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ: ${newLat.toFixed(5)}, ${newLng.toFixed(5)} (ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å†è¨­å®šå¯èƒ½)`;
                statusMessage.style.color = '#3b82f6'; 
            });
            
            // invalidateSizeã‚’é…å»¶å®Ÿè¡Œ (ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å•é¡Œã®å¯¾ç­–)
            setTimeout(() => {
                if (mapInstance) {
                    mapInstance.invalidateSize();
                }
            }, 50); 
        }

        function handleLocationError(message) {
            if (geoAttemptCompleted) return;
            geoAttemptCompleted = true;
            clearTimeout(geoTimer); 
            const mapDiv = document.getElementById('map'); 
            const statusMessage = document.getElementById('location-status');
            if (mapDiv) { mapDiv.style.display = 'none'; }
            statusMessage.textContent = 'ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚';
            statusMessage.style.color = 'red'; 
        }

        function geoSuccess(position) {
            if (geoAttemptCompleted) return;
            geoAttemptCompleted = true;
            clearTimeout(geoTimer); 
            const latitudeInput = document.getElementById('latitude');
            const longitudeInput = document.getElementById('longitude');
            const statusMessage = document.getElementById('location-status');
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            latitudeInput.value = lat;
            longitudeInput.value = lng;
            statusMessage.textContent = `ä½ç½®æƒ…å ±ã®å–å¾—ã«æˆåŠŸã—ã¾ã—ãŸã€‚ç¾åœ¨åœ°: ${lat.toFixed(5)}, ${lng.toFixed(5)} (ãƒãƒƒãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã§å ´æ‰€ã‚’å¤‰æ›´)`;
            statusMessage.style.color = 'green';
            initializeMap(lat, lng);
        }

        function geoError(error) { handleLocationError(error.message); }

        document.addEventListener('DOMContentLoaded', function() {
            if (navigator.geolocation) {
                geoTimer = setTimeout(() => {
                    if (!geoAttemptCompleted) { handleLocationError("å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼ˆã‚·ã‚¹ãƒ†ãƒ å¼·åˆ¶ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼‰ã€‚"); }
                }, TIMEOUT_DURATION);

                navigator.geolocation.getCurrentPosition(
                    geoSuccess, geoError,
                    { enableHighAccuracy: true, timeout: TIMEOUT_DURATION, maximumAge: 0 }
                );
            } else {
                handleLocationError('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ä½ç½®æƒ…å ±ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
            }
        });
    </script>
{% endblock %}