{% extends 'top_base.html' %} 

{% block title %}å ±å‘Šã®è©³ç´° - ã¾ã¡ãƒ¬ãƒç®¡ç†è€…{% endblock %}


{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<style>
    /* .modal-overlay ã®å¿…é ˆã‚¹ã‚¿ã‚¤ãƒ«ã‚’å®šç¾©ã—ã€å…¨ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹ */
    .modal-overlay {
        position: fixed; /* ç”»é¢ã«å›ºå®š */
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 50;
        background-color: rgba(0, 0, 0, 0.6); /* åŠé€æ˜ã®é»’èƒŒæ™¯ */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    /* hidden ã‚¯ãƒ©ã‚¹ãŒã¤ã„ã¦ã„ã‚Œã°éè¡¨ç¤ºã«ã™ã‚‹ */
    .modal-overlay.hidden {
        display: none !important; 
    }
    /* .modal-box ã®åŸºæœ¬çš„ãªã‚¹ã‚¿ã‚¤ãƒ« */
    .modal-box {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 100%;
        max-width: 440px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative; /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå‰é¢ã«ãã‚‹ã‚ˆã†ã« */
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®ãƒœã‚¿ãƒ³é…ç½® */
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }


    .custom-div-icon {
        background-color: #e53e3e; /* èµ¤ */
        border: 3px solid #ffffff; /* ç™½ã„ç¸ */
        width: 15px; /* ã‚µã‚¤ã‚º */
        height: 15px;
        border-radius: 50%; /* å††å½¢ */
        opacity: 0.9;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }


    
</style>


<div class="p-4 md:p-8">
    <div class="page-container">

        <header class="app-header">
            <div class="title">ã¾ã¡ãƒ¬ãƒ ç®¡ç†è€…ãƒšãƒ¼ã‚¸</div>
            <a href="{% url 'logout' %}" class="header-link">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
        </header>
        
        <main class="main-content">
            <a href="{% url 'admin_post_list' %}" class="link-secondary" style="margin: 0 0 1.5rem 0; text-align: left;"> &lt; ç®¡ç†ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«æˆ»ã‚‹
            </a>

            <h1 class="text-3xl font-bold text-gray-900 mb-6">å ±å‘Šè©³ç´°</h1>
            

            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-1">ã‚¿ã‚¤ãƒˆãƒ«:</label>
                <p class="bg-gray-50 p-3 border border-gray-300 rounded-md whitespace-pre-wrap">{{ post.title|default:"(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)" }}</p>
            </div>

            
            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-2">å†™çœŸ:</label>
                <div class="bg-gray-200 rounded-md overflow-hidden border border-gray-300 h-64">
                    {% if post.photo %}
                        <img src="{{ post.photo.url }}" alt="å ±å‘Šå†™çœŸ: {{ post.title }}" class="post-photo">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-500">
                            å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“
                        </div>
                    {% endif %}
                </div>
                
            </div>

            
            
            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-2">å ´æ‰€:</label>
                <div class="bg-gray-50 rounded-md border border-gray-300 p-3">
                    <p class="text-gray-800">
                        {% if post.location_name %}
                            {{ post.location_name }}
                        {% elif post.latitude and post.longitude %}
                            {% if post.latitude and post.longitude %}
                                <div class="form-group mb-6">
                                    <label class="block text-gray-700 font-medium mb-2">åœ°å›³è¡¨ç¤º (OpenStreetMap):</label>
                                    <div id="map-display"></div>
                                </div>
                            {% endif %}
                        {% else %}
                            ä½ç½®æƒ…å ±ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-1">ã‚«ãƒ†ã‚´ãƒª:</label>
                <p class="text-gray-800">
                    {% if post.tags.first %}
                        {{ post.tags.first.name }}
                    {% else %}
                        (ã‚¿ã‚°ãªã—)
                    {% endif %}
                </p>
            </div>

            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-1">è©³ç´°:</label>
                <p class="bg-gray-50 p-3 border border-gray-300 rounded-md whitespace-pre-wrap">{{ post.comment | linebreaks }}</p>
            </div>
            
            {% if post.admin_note %}
            <div class="form-group mb-6 p-3 bg-indigo-50 border border-indigo-200 rounded-md">
                <label class="block text-indigo-700 font-medium mb-1">ç®¡ç†è€…ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ:</label>
                <p class="text-indigo-800 whitespace-pre-wrap">{{ post.admin_note | linebreaks}}</p>
            </div>
            {% endif %}

        

            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mt-8 pt-6 border-t border-gray-200">
                <a href="{% url 'admin_post_status_edit' post_id=post.id %}" class="btn btn-primary flex-1 text-center py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold transition duration-150">
                    ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¨˜éŒ²ã™ã‚‹
                </a>
                
                <button type="button" onclick="openDeleteModal('{% if post.title %}{{ post.title|escapejs }}{% else %}ã‚¿ã‚¤ãƒˆãƒ«ãªã—{% endif %}')" class="btn btn-secondary" style="border: 1px solid #ef4444; color: #ef4444;">
                    ã“ã®å ±å‘Šã‚’å‰Šé™¤ã™ã‚‹
                </button>
            </div>

        

        </main>

        <div id="delete-modal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="modal-box">
            
                
                <h2 class="text-2xl font-extrabold text-red-700 mb-4" id="modal-title">æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ</h2>
                
                <p class="text-sm text-gray-600 mb-6 border-b pb-4">
                    ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚ Â  Â  Â  Â  Â  Â  Â  Â 
                </p>
                

                
                <div class="modal-actions">
                    <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary" style="flex: 1; margin-top: 0;">
                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                    </button>
                    
                    <form id="deleteForm" method="post" action="{% url 'admin_post_delete' post_id=post.pk %}" style="display: inline; flex: 1;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger" style="width: 100%;">
                            å‰Šé™¤
                        </button>
                    </form>
                </div>
                
            </div>
        </div>

    </div>
Â 
</div>



<script>
    const deleteModal = document.getElementById('delete-modal');
    const postTitlePlaceholder = document.getElementById('postTitlePlaceholder');

    /**
     * å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤ºã—ã€å ±å‘Šã‚¿ã‚¤ãƒˆãƒ«ã‚’ã‚»ãƒƒãƒˆã™ã‚‹é–¢æ•°ã€‚
     */
    function openDeleteModal(postTitle) {
        if (postTitlePlaceholder) {
            postTitlePlaceholder.textContent = postTitle;
        }
        
        if (deleteModal) {
            deleteModal.classList.remove('hidden');
            console.log("Delete Modal opened successfully."); 
        } else {
            console.error("Delete Modal element not found! Check HTML ID."); 
        }
    }

    /**
     * å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹é–¢æ•°ã€‚
     */
    function closeDeleteModal() {
        if (deleteModal) {
            deleteModal.classList.add('hidden');
            console.log("Delete Modal closed."); 
        }
    }
    
    // äº’æ›æ€§ã®ãŸã‚ã€closeModalã‚’closeDeleteModalã«ãƒãƒƒãƒ—
    function closeModal() {
        closeDeleteModal();
    }


    // ãƒ¢ãƒ¼ãƒ€ãƒ«èƒŒæ™¯ã‚¯ãƒªãƒƒã‚¯ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹æ©Ÿèƒ½
    if (deleteModal) {
        deleteModal.addEventListener('click', function(event) {
            // ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ãƒ¼ã‚²ãƒƒãƒˆãŒdeleteModalè‡ªèº«ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ã§ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        });
    }





{% if post.latitude and post.longitude %}
    
    // æŠ•ç¨¿ã®ä½ç½®æƒ…å ± (Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã§å€¤ã‚’æŒ¿å…¥)
    const lat = {{ post.latitude|default:"0" }}; 
    const lng = {{ post.longitude|default:"0" }};
    const locationName = "{% if post.location_name %}{{ post.location_name|escapejs }}{% else %}å ±å‘Šã•ã‚ŒãŸå ´æ‰€{% endif %}";
    
    // ğŸ’¡ è¿½åŠ : L.divIcon ã‚’å®šç¾© ğŸ’¡
    const customIcon = L.divIcon({
        className: 'custom-div-icon', // ä¸Šã§å®šç¾©ã—ãŸCSSã‚¯ãƒ©ã‚¹
        iconSize: [15, 15],           // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º
        iconAnchor: [7.5, 7.5],       // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒï¼ˆæ­£ç¢ºãªä½ç½®åˆã‚ã›ï¼‰
        popupAnchor: [0, -10]         // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®èª¿æ•´
    });


    function initLeafletMap() {
        // ç·¯åº¦ãƒ»çµŒåº¦ãŒæœ‰åŠ¹ãªå€¤ã§ã‚ã‚‹ã‹ç¢ºèª
        if (lat === 0 && lng === 0 || typeof L === 'undefined') return; 

        // 1. Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ (çœç•¥)
        const map = L.map('map-display').setView([lat, lng], 16); 
        
        // 2. ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ  (çœç•¥)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(map);

        // 3. ğŸ’¡ ãƒãƒ¼ã‚«ãƒ¼ï¼ˆè¨˜å·ï¼‰ã‚’è¿½åŠ  (L.divIconã‚’ä½¿ç”¨) ğŸ’¡
        const marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
        
        // 4. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆå¹ãå‡ºã—ï¼‰ã‚’è¿½åŠ  (çœç•¥)
        marker.bindPopup(`<b>${locationName}</b><br>ç·¯åº¦: ${lat}<br>çµŒåº¦: ${lng}`).openPopup();
        
        // ğŸ’¡ Leafletã«ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã‚’å†èªè­˜ã•ã›ã‚‹
        map.invalidateSize();
        
        console.log(`Leaflet Map initialized at: ${lat}, ${lng} with custom div icon.`);
    }

    // é…å»¶å®Ÿè¡Œ: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å®‰å®šåŒ–ã®ãŸã‚
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initLeafletMap, 100);
    });
    
{% endif %}
</script>


{% endblock %}