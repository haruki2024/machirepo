{% extends 'top_base_admin.html' %} 

{% block title %}報告の詳細 - まちレポ管理者{% endblock %}


{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<style>
    /* .modal-overlay の必須スタイルを定義し、全画面に表示されるようにする */
    .modal-overlay {
        position: fixed; /* 画面に固定 */
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 50;
        background-color: rgba(0, 0, 0, 0.6); /* 半透明の黒背景 */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    /* hidden クラスがついていれば非表示にする */
    .modal-overlay.hidden {
        display: none !important; 
    }
    /* .modal-box の基本的なスタイル */
    .modal-box {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 100%;
        max-width: 440px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative; /* モーダルコンテンツが前面にくるように */
    }
    /* モーダル内のボタン配置 */
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }


    .custom-div-icon {
        background-color: #e53e3e; /* 赤 */
        border: 3px solid #ffffff; /* 白い縁 */
        width: 15px; /* サイズ */
        height: 15px;
        border-radius: 50%; /* 円形 */
        opacity: 0.9;
        box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
    }


    
</style>




<main class="main-content report-detail">
    <a href="{% url "admin_post_list" %}" class="link-secondary">&lt; 一覧に戻る</a>
    
    
      
        {% if is_valid %}
            <div class="error-box">
                <p style="color: red;">この投稿は信頼度の低い投稿になっています。</p>
                <p>まちレポに関係のない写真である可能性があります。正しい写真か注意して確認してください。地域の不具合（{{ confidence }}%）</p>
            </div>
        {% endif %}
    
    
    <div class="history-item-header">
        <div>
            <h2 style="padding-top: -10rem; margin-left: 0rem;">{{ post.title|default:"(タイトルなし)" }}</h2>
        </div>
        <div class="status-wrapper">
            <span class="status-badge 
                    {% if post.status == 'new' %}status-new
                    {% elif post.status == 'in_progress' %}status-pending
                    {% elif post.status == 'completed' %}status-complete
                    {% elif post.status == 'not_required' %}status-not-applicable
                    {% endif %}" style="margin-right: 1rem;">
                {{ post.get_status_display }}
            </span>
            {% if post.priority %}
                <span class="priority-badge priority-{{ post.priority }}">
                    {{ post.get_priority_display }}
                </span>
            {% else %}
                <span class="priority-badge priority-none">--</span>
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label>報告者:</label>
        <p>{{ post.user.username|default:"(該当ユーザーなし)" }}</p> 
    </div>
    
    <div class="form-group"style="margin-top:2rem;">
        <label>投稿日時:</label>
        <p>{{ post.posted_at|date:"Y/m/d H:i" }}</p> 
    </div>
    
    <div class="form-group" style="margin-top:2rem;">
        <label>写真:</label>
        
        <div class="detail-placeholder-box">
            {% if post.photo %}
                <img src="{{ post.photo.url }}" alt="報告写真: {{ post.title }}" class="post-photo" style=" width: 100%;">
            {% else %}
                <div class="w-full h-full flex items-center justify-center text-gray-500">
                    写真がありません
                </div>
            {% endif %}
        </div>
    </div>
    
    
    
    <div class="form-group">
        <label>場所:</label>
        <div class="bg-gray-50 rounded-md border border-gray-300 p-3">
        
            {% if post.location_name %}
                {{ post.location_name }}
            {% elif post.latitude and post.longitude %}
                {% if post.latitude and post.longitude %}
                    
                    <div id="map-display"></div>
                {% endif %}
            {% else %}
                位置情報は記録されていません
            {% endif %}
        
        </div>
    </div>
    <div class="form-group" style="margin-top:2rem;">
        <label>カテゴリ:</label>
        <p class="detail-data-box">
            {% if post.tag %}
                {{ post.tag.name }}
            {% else %}
                (タグなし)
            {% endif %}
        </p>
    </div>
    <div class="form-group" style="margin-top:2rem;">
        <label>詳細:</label>
        <p class="detail-data-box">{{ post.comment}}</p>
    </div>
    {% if post.admin_note %}
    <div class="form-group" style="margin-top:2rem;">
        <label>管理者からのコメント:</label>
        <p class="detail-data-box">{{ post.admin_note}}</p>
    </div>
    {% endif %}

    <div style="height: 2rem;"></div>
    <a href="{% url 'admin_post_status_edit' post_id=post.id %}" style="margin-bottom: 1rem;" class="btn btn-primary flex-1 text-center py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold transition duration-150">
        ステータスを記録する
    </a>
    
    <button type="button" onclick="openDeleteModal('{% if post.title %}{{ post.title|escapejs }}{% else %}タイトルなし{% endif %}')" class="btn btn-secondary" style="border: 1px solid #ef4444; color: #ef4444; margin-bottom: 1rem;">
        この報告を削除する
    </button>

</main>



<div id="delete-modal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="modal-box">
    
        
        <h2 class="text-2xl font-extrabold text-red-700 mb-4" id="modal-title">本当に削除しますか？</h2>
        
        <p class="text-sm text-gray-600 mb-6 border-b pb-4">
            この操作は取り消せません。                
        </p>
        

        
        <div class="modal-actions">
            <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary" style="flex: 1; margin-top: 0;">
                キャンセル
            </button>
            
            <form id="deleteForm" method="post" action="{% url 'admin_post_delete' post_id=post.pk %}" style="display: inline; flex: 1;">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" style="width: 100%;">
                    削除
                </button>
            </form>
        </div>
        
    </div>
</div>




<script>
    const deleteModal = document.getElementById('delete-modal');
    const postTitlePlaceholder = document.getElementById('postTitlePlaceholder');

    function openDeleteModal(postTitle) {
        if (postTitlePlaceholder) {
            postTitlePlaceholder.textContent = postTitle;
        }
        
        if (deleteModal) {
            deleteModal.classList.remove('hidden');
            console.log("Delete Modal opened successfully."); 
        } else {
            console.error("Delete Modal element not found! Check HTML ID."); 
        }
    }

    function closeDeleteModal() {
        if (deleteModal) {
            deleteModal.classList.add('hidden');
            console.log("Delete Modal closed."); 
        }
    }
    
    function closeModal() {
        closeDeleteModal();
    }

    if (deleteModal) {
        deleteModal.addEventListener('click', function(event) {

            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        });
    }






    
    const lat = {{ post.latitude|default:"0" }}; 
    const lng = {{ post.longitude|default:"0" }};
    const locationName = "{% if post.location_name %}{{ post.location_name|escapejs }}{% else %}報告された場所{% endif %}";
    
    const customIcon = L.divIcon({
        className: 'custom-div-icon',
        iconSize: [15, 15],
        iconAnchor: [7.5, 7.5],
        popupAnchor: [0, -10]
    });

    function initLeafletMap() {
        if (lat === 0 && lng === 0 || typeof L === 'undefined') return; 

        const map = L.map('map-display').setView([lat, lng], 16); 
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(map);

        const marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
        
        marker.bindPopup(`<b>${locationName}</b><br>緯度: ${lat}<br>経度: ${lng}`).openPopup();
        
        map.invalidateSize();
        
        console.log(`Leaflet Map initialized at: ${lat}, ${lng} with custom div icon.`);
    }

    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initLeafletMap, 100);
    });
    

</script>


{% endblock %}