{% extends 'top_base.html' %} 

{% block title %}投稿一覧{% endblock %} 

{% block content %}

<div class="sub-header" style="margin-bottom:1rem;">
    <a href="{% url "user_home" %}" class="back-link">&lt; 戻る</a>
    <h2 class="page-title">みんなの投稿</h2>
</div>

<main class="main-content list-page-main">
    
    <form method="get" action="{% url 'post_list' %}" id="filter-form" class="filter-container" style="display: flex; gap: 1rem; margin-bottom: 1.5rem; background-color: #f9fafb; padding: 1rem; border-radius: 8px;">
        <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label for="filter-status">ステータスで絞り込み</label>
            <select id="filter-status" name="status" class="form-select js-filter-select"> <option value="">すべて</option>
                {% for value, label in posts.model.STATUS_CHOICES %}
                    <option value="{{ value }}" {% if status_filter == value %}selected{% endif %}>{{ label }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group" style="flex: 1; margin-bottom: 0;">
            <label for="filter-tag">タグで絞り込み</label>
            <select id="filter-tag" name="tag" class="form-select js-filter-select"> <option value="">すべて</option>
                {% for tag in all_tags %}
                <option value="{{ tag.id }}" {% if tag_filter|safe == tag.id|safe %}selected{% endif %}>{{ tag.name }}</option>
                {% endfor %}    
            </select>
        </div>
        
    </form>
        
    {% if posts %}
        {% for post in posts %}
            <a href="{% url 'post_detail' post.id %}"  class="post-card-link" style="text-decoration: none;" >
                
                <div class="history-item post-feed-item">
                    <div class="history-item-header">
                        <div>
                            <p class="history-item-title">{{ post.title|default:"タイトルなし" }}</p>
                            <p class="history-item-date">{{ post.posted_at|date:"Y/m/d H:i" }}</p>
                        </div>
                        
                        <div class="status-wrapper">
                            
                            {# ステータスバッジ: get_status_display()で日本語の表示名を取得 #}
                            <span class="status-badge 
                                    {% if post.status == 'new' %}status-new
                                    {% elif post.status == 'in_progress' %}status-pending
                                    {% elif post.status == 'completed' %}status-complete
                                    {% elif post.status == 'not_required' %}status-not-applicable
                                    {% endif %}">
                                {{ post.get_status_display }}
                            </span>
                        </div>
                    </div>
                    {% if post.admin_note %}
                        
                        <div class="admin-comment">
                            <label class="comment-title">管理者からのコメント</label>
                            <p class="comment-body">{{ post.admin_note | linebreaks}}</p>
                        </div>
                    {% endif %}
                </div>
            </a>
        {% endfor %}
    {% else %}
        <div style="text-align: center; padding: 4rem; background-color: #f9fafb; border-radius: 8px; margin-top: 2rem;">
            <p style="color: #6b7280;">現在、新しい報告はありません。</p>
        </div>
    {% endif %}

</main>


<script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterSelects = document.querySelectorAll('.js-filter-select');
        
        const filterForm = document.getElementById('filter-form');

        if (filterForm) {
            filterSelects.forEach(function(selectElement) {
                selectElement.addEventListener('change', function() {
                    filterForm.submit();
                    console.log("セレクトボックスが変更されました。フォームを自動送信します。");
                });
            });
            
        } else {
            console.error("ID 'filter-form' の要素が見つかりませんでした。HTMLを確認してください。");
        }
    });
</script>

{% endblock %}