{% extends 'top_base.html' %} 

{% block title %}å ±å‘Šã®è©³ç´°{% endblock %}


{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>



<div class="sub-header">
    <a href="{% url "user_home" %}" class="back-link">&lt; æˆ»ã‚‹</a>
    <h2 class="page-title">æŠ•ç¨¿è©³ç´°</h2>
</div>
<main class="main-content list-page-main">
    
    
    
    <div class="detail-meta-wrapper">
        <div class="detail-meta-item">
            <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
            <p class="detail-title-text">{{ post.title|default:"(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)" }}</p>
        </div>
        <div class="detail-meta-item" style="text-align: right; flex-shrink: 0;">
            <span class="status-badge 
                    {% if post.status == 'new' %}status-new
                    {% elif post.status == 'in_progress' %}status-pending
                    {% elif post.status == 'completed' %}status-complete
                    {% elif post.status == 'not_required' %}status-not-applicable
                    {% endif %}">
                {{ post.get_status_display }}
            </span>
        </div>
    </div>

    <div class="detail-group">
        <label>æŠ•ç¨¿æ—¥</label>
        <span class="detail-data-text">{{ post.posted_at|date:"Y/m/d H:i" }}</span>
    </div>

    <div class="detail-group">
        <label>å†™çœŸ</label>
        
        <div class="detail-placeholder-box">
            {% if post.photo %}
                <img src="{{ post.photo.url }}" alt="å ±å‘Šå†™çœŸ: {{ post.title }}" class="post-photo" style=" width: 100%;">
            {% else %}
                <div class="w-full h-full flex items-center justify-center text-gray-500">
                    å†™çœŸãŒã‚ã‚Šã¾ã›ã‚“
                </div>
            {% endif %}
        </div>
    </div>

    <div class="detail-group">
        <label>å ´æ‰€</label>
        <div class="bg-gray-50 rounded-md border border-gray-300 p-3">
            <p class="text-gray-800">
                {% if post.location_name %}
                    {{ post.location_name }}
                {% elif post.latitude and post.longitude %}
                    {% if post.latitude and post.longitude %}
                        <div class="form-group mb-6">
                            <label class="block text-gray-700 font-medium mb-2">åœ°å›³è¡¨ç¤º (OpenStreetMap):</label>
                            <div id="map-display"></div>
                        </div>
                    {% endif %}
                {% else %}
                    ä½ç½®æƒ…å ±ã¯è¨˜éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“
                {% endif %}
            </p>
        </div>
    </div>

    <div class="detail-group">
        <label>è©³ç´°</label>
        <p class="detail-data-box">{{ post.comment}}</p>
    </div>
    
    {% if post.admin_note %}
        <div class="detail-group">
            <label>ç®¡ç†è€…ã‹ã‚‰ã®ã‚³ãƒ¡ãƒ³ãƒˆ</label>
            <div class="admin-comment" style="margin-top:0; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem;">
                <p class="comment-body">{{ post.admin_note}}</p>
            </div>
        </div>
    {% endif %}
    <div style="height: 2rem;"></div>

</main>





<script>

{% if post.latitude and post.longitude %}
    
    // æŠ•ç¨¿ã®ä½ç½®æƒ…å ± (Djangoã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¿ã‚°ã§å€¤ã‚’æŒ¿å…¥)
    const lat = {{ post.latitude|default:"0" }}; 
    const lng = {{ post.longitude|default:"0" }};
    const locationName = "{% if post.location_name %}{{ post.location_name|escapejs }}{% else %}å ±å‘Šã•ã‚ŒãŸå ´æ‰€{% endif %}";
    
    // ğŸ’¡ è¿½åŠ : L.divIcon ã‚’å®šç¾© ğŸ’¡
    const customIcon = L.divIcon({
        className: 'custom-div-icon', // ä¸Šã§å®šç¾©ã—ãŸCSSã‚¯ãƒ©ã‚¹
        iconSize: [15, 15],           // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º
        iconAnchor: [7.5, 7.5],       // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒï¼ˆæ­£ç¢ºãªä½ç½®åˆã‚ã›ï¼‰
        popupAnchor: [0, -10]         // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®èª¿æ•´
    });


    function initLeafletMap() {
        // ç·¯åº¦ãƒ»çµŒåº¦ãŒæœ‰åŠ¹ãªå€¤ã§ã‚ã‚‹ã‹ç¢ºèª
        if (lat === 0 && lng === 0 || typeof L === 'undefined') return; 

        // 1. Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ (çœç•¥)
        const map = L.map('map-display').setView([lat, lng], 16); 
        
        // 2. ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ  (çœç•¥)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(map);

        // 3. ğŸ’¡ ãƒãƒ¼ã‚«ãƒ¼ï¼ˆè¨˜å·ï¼‰ã‚’è¿½åŠ  (L.divIconã‚’ä½¿ç”¨) ğŸ’¡
        const marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
        
        // 4. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆå¹ãå‡ºã—ï¼‰ã‚’è¿½åŠ  (çœç•¥)
        marker.bindPopup(`<b>${locationName}</b><br>ç·¯åº¦: ${lat}<br>çµŒåº¦: ${lng}`).openPopup();
        
        // ğŸ’¡ Leafletã«ã‚³ãƒ³ãƒ†ãƒŠã‚µã‚¤ã‚ºã‚’å†èªè­˜ã•ã›ã‚‹
        map.invalidateSize();
        
        console.log(`Leaflet Map initialized at: ${lat}, ${lng} with custom div icon.`);
    }

    // é…å»¶å®Ÿè¡Œ: ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã®å®‰å®šåŒ–ã®ãŸã‚
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initLeafletMap, 100);
    });
    
{% endif %}
</script>


{% endblock %}