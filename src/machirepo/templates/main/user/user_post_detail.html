{% extends 'top_base.html' %} 

{% block title %}報告の詳細{% endblock %}


{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>



<div class="sub-header">
    <a href="{% url "user_home" %}" class="back-link">&lt; 戻る</a>
    <h2 class="page-title">投稿詳細</h2>
</div>
<main class="main-content">
    
    
    
    <div class="detail-meta-wrapper">
        <div class="detail-meta-item">
            <label>タイトル</label>
            <p class="detail-title-text">{{ post.title|default:"(タイトルなし)" }}</p>
        </div>
        <div class="detail-meta-item" style="text-align: right; flex-shrink: 0;">
            <span class="status-badge 
                    {% if post.status == 'new' %}status-new
                    {% elif post.status == 'in_progress' %}status-pending
                    {% elif post.status == 'completed' %}status-complete
                    {% elif post.status == 'not_required' %}status-not-applicable
                    {% endif %}">
                {{ post.get_status_display }}
            </span>
        </div>
    </div>

    <div class="detail-group">
        <label>投稿日</label>
        <span class="detail-data-text">{{ post.posted_at|date:"Y/m/d H:i" }}</span>
    </div>
    <div class="detail-group">
        <label>報告者</label>
        <div class="badge-icon">
            <span class="detail-data-text" style="margin-top:0.2rem;">{{post.user.username}}</span>
            {% if "none" == post.user.badge_rank%}
                <p></p>
            {% else %}
                <img src="/media/images/badge_{{ post.user.badge_rank }}.png" alt="銅バッジ" style="margin-left:0.5rem; width:30px; height:30px;">
            {% endif %}
            
        </div>
    </div>
    <div class="detail-group">
        <label>写真</label>
        
        <div class="detail-placeholder-box">
            {% if post.photo %}
                <img src="{{ post.photo.url }}" alt="報告写真: {{ post.title }}" class="post-photo" style=" width: 100%;">
            {% else %}
                <div class="w-full h-full flex items-center justify-center text-gray-500">
                    写真がありません
                </div>
            {% endif %}
        </div>
    </div>

    <div class="detail-group">
        <label>場所</label>
        <div class="bg-gray-50 rounded-md border border-gray-300 p-3">
            <p class="text-gray-800">
                {% if post.location_name %}
                    {{ post.location_name }}
                {% elif post.latitude and post.longitude %}
                    {% if post.latitude and post.longitude %}
                        <div class="form-group mb-6">
                            <label class="block text-gray-700 font-medium mb-2">地図表示 (OpenStreetMap):</label>
                            <div id="map-display"></div>
                        </div>
                    {% endif %}
                {% else %}
                    位置情報は記録されていません
                {% endif %}
            </p>
        </div>
    </div>

    <div class="detail-group">
        <label>詳細</label>
        <p class="detail-data-box">{{ post.comment}}</p>
    </div>
    
    {% if post.admin_note %}
        <div class="detail-group">
            <label>管理者からのコメント</label>
            <div class="admin-comment" style="margin-top:0; background-color: #f9fafb; padding: 1rem; border-radius: 0.5rem;">
                <p class="comment-body">{{ post.admin_note}}</p>
            </div>
        </div>
    {% endif %}
    <div style="height: 2rem;"></div>

</main>





<script>

{% if post.latitude and post.longitude %}
    
    const lat = {{ post.latitude|default:"0" }}; 
    const lng = {{ post.longitude|default:"0" }};
    const locationName = "{% if post.location_name %}{{ post.location_name|escapejs }}{% else %}報告された場所{% endif %}";
    

    const customIcon = L.divIcon({
        className: 'custom-div-icon', // 上で定義したCSSクラス
        iconSize: [15, 15],           // アイコンサイズ
        iconAnchor: [7.5, 7.5],       // アイコンの中心（正確な位置合わせ）
        popupAnchor: [0, -10]         // ポップアップ位置調整
    });


    function initLeafletMap() {
        if (lat === 0 && lng === 0 || typeof L === 'undefined') return; 

        const map = L.map('map-display').setView([lat, lng], 16); 
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            maxZoom: 19,
        }).addTo(map);

        const marker = L.marker([lat, lng], {icon: customIcon}).addTo(map);
        
        marker.bindPopup(`<b>${locationName}</b><br>緯度: ${lat}<br>経度: ${lng}`).openPopup();
        
        map.invalidateSize();
        
        console.log(`Leaflet Map initialized at: ${lat}, ${lng} with custom div icon.`);
    }

    // 遅延実行: レンダリングの安定化のため
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(initLeafletMap, 100);
    });
    
{% endif %}
</script>


{% endblock %}