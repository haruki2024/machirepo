{% extends 'top_base.html' %} 

{% block title %}新規投稿{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
.input-file-trick {
  position: absolute;
  left: -9999px;
  width: 1px;
  height: 1px;
  overflow: hidden;
}

#map-wrapper {
  text-align: center;
  margin-top: 0.5rem;
}

#map {
  width: 100%;
  max-width: 800px; 
  height: 360px;
  margin: 0 auto;
  border-radius: 8px;
  box-shadow: 0 6px 12px rgba(0,0,0,0.08);
  display: none;
  box-sizing: border-box;
  z-index: 0;
}

#location-status { font-size: 0.95rem; color: #6b7280; margin-top: 0.5rem; }
</style>
{% endblock %}

{% block content %}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<div class="sub-header" style="margin-bottom:1rem;">
    <a href="{% url "user_home" %}" class="back-link">&lt; 戻る</a>
    <h2 class="page-title">新規投稿</h2>
</div>
<main class="main-content form-page-main">
    <form method="POST" enctype="multipart/form-data">
        {% csrf_token %}
        
        
        <div class="form-group">
            <label for="title">タイトル</label>
            {{ form.title }}
            {% if form.title.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.title.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>

        <div class="form-group">
            <label>不具合箇所の写真</label>
            <img id="photo-preview" alt="アップロードされた写真のプレビュー" style="max-width: 100%;　border-radius: 8px; object-fit: contain; border: 1px solid #ddd; margin-bottom: 1rem; display: none;">
            <div class="photo-upload-area">
                <div class="mt-3">
                    <label for="photo" class="btn btn-primary">
                        アップロード
                    </label>
                    <input type="file" name="photo" id="photo" class="input-file-trick" accept="image/*">
                </div>

                <p id="file-name-display" class="text-sm mt-2 text-gray-700">
                    ファイルが選択されていません。
                </p>

                {% if form.photo.errors %}
                    <div class="errorlist text-red-500 text-sm mt-1 list-none p-0">
                    {% for error in form.photo.errors %}{{ error }}{% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-group">
            <label>場所の指定</label>
            <div id="map-wrapper">
                <div id="map" class="map-container"></div>
            </div>
            <p id="location-status">位置情報を取得しています...</p>
            
            <input type="hidden" id="latitude" name="latitude" value="{{ default_lat }}">
            <input type="hidden" id="longitude" name="longitude" value="{{ default_lng }}">
            <input type="hidden" id="location_name" name="location_name" value="">
            
            {% if form.non_field_errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.non_field_errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
        
        <div class="form-group">
            <label for="category">カテゴリ</label>
            {{ form.tag }}
            {% if form.tag.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.tag.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>
        
        <div class="form-group">
            <label for="comment">詳細</label>
            {{ form.comment }}
            {% if form.comment.errors %}<div class="errorlist text-red-500 text-sm mt-1 list-none p-0">{% for error in form.comment.errors %}{{ error }}{% endfor %}</div>{% endif %}
        </div>

        <div class="form-submit-container">
            <button type="submit" class="btn btn-primary" style="width: 100%;">投稿</button>
        </div>
    </form>
</main>

<script>
delete L.Icon.Default.prototype._getIconUrl;

const customIcon = L.divIcon({
    className: 'custom-div-icon',
    iconSize: [15, 15],
    iconAnchor: [7.5, 7.5],
    popupAnchor: [0, -10]
});

let mapInstance = null;
let markerInstance = null;

(function setupPhotoPreview() {
    const photoElement = document.getElementById('photo-preview');
    const fileNameDisplay = document.getElementById('file-name-display');
    const fileInput = document.getElementById('photo');

    const photoFileName = "{{ post_data.photo_path|default:'' }}";
    if (photoFileName) {
        const MEDIA_URL_PREFIX = '/media/';
        photoElement.src = MEDIA_URL_PREFIX + photoFileName;
        photoElement.style.display = 'block';
        if (fileNameDisplay) fileNameDisplay.textContent = '過去の投稿データから写真を読み込みました。';
    } else {
        photoElement.style.display = 'none';
        if (fileNameDisplay) fileNameDisplay.textContent = 'ファイルが選択されていません。';
    }

    if (!fileInput) return;

    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (!file) {
            photoElement.style.display = 'none';
            photoElement.src = '';
            fileNameDisplay.textContent = 'ファイルが選択されていません。';
            return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            photoElement.src = e.target.result;
            photoElement.style.display = 'block';
            fileNameDisplay.textContent = `選択中のファイル: ${file.name} `;
        };
        reader.readAsDataURL(file);
    });
})();

/* ===========================================
   地図の初期化（1回だけ生成する設計）
   =========================================== */
function initializeMap(lat, lng) {
    const mapDiv = document.getElementById('map');
    const latitudeInput = document.getElementById('latitude');
    const longitudeInput = document.getElementById('longitude');
    const statusMessage = document.getElementById('location-status');

    mapDiv.style.display = 'block';
    
    if (!mapInstance) {
        mapDiv.style.width = '100%';
        mapDiv.style.maxWidth = '800px';
        mapDiv.style.height = mapDiv.style.height || '360px';

        mapInstance = L.map('map', { zoomControl: true, attributionControl: true }).setView([lat, lng], 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(mapInstance);

        markerInstance = L.marker([lat, lng], { icon: customIcon }).addTo(mapInstance)
            .bindPopup('投稿場所').openPopup();
        
        mapInstance.on('click', function(e) {
            const newLat = e.latlng.lat;
            const newLng = e.latlng.lng;
            if (markerInstance) markerInstance.setLatLng([newLat, newLng]);
            latitudeInput.value = newLat;
            longitudeInput.value = newLng;
            statusMessage.textContent = `投稿場所が変更されました: ${newLat.toFixed(5)}, ${newLng.toFixed(5)} (マップをクリックで再設定可能)`;
            statusMessage.style.color = '#3b82f6';
        });
        
        setTimeout(() => {
            try { mapInstance.invalidateSize(); } catch (e) { /* ignore */ }
        }, 100);

        return;
    }

    mapInstance.setView([lat, lng], 16);
    if (markerInstance) markerInstance.setLatLng([lat, lng]);
    setTimeout(() => { try { mapInstance.invalidateSize(); } catch (e){} }, 80);
}

/* ===========================================
   位置情報取得ロジック（タイムアウト付き）
   =========================================== */
(function setupGeolocation() {
    const TIMEOUT_MS = 5000;
    let geoAttemptCompleted = false;
    let geoTimer = null;
    const statusMessage = document.getElementById('location-status');

    function handleLocationError(msg) {
        if (geoAttemptCompleted) return;
        geoAttemptCompleted = true;
        if (geoTimer) clearTimeout(geoTimer);
        statusMessage.textContent = '位置情報の取得に失敗しました。次の画面で手動で位置を登録してください';
        statusMessage.style.color = 'red';

    }

    function geoSuccess(position) {
        if (geoAttemptCompleted) return;
        geoAttemptCompleted = true;
        if (geoTimer) clearTimeout(geoTimer);

        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        document.getElementById('latitude').value = lat;
        document.getElementById('longitude').value = lng;

        statusMessage.textContent = `位置情報の取得に成功しました。現在地: ${lat.toFixed(5)}, ${lng.toFixed(5)} (マップをクリックで場所を変更)`;
        statusMessage.style.color = 'green';
        initializeMap(lat, lng);
    }

    function geoError(err) {
        console.warn('geolocation error', err);
        handleLocationError(err && err.message ? err.message : '位置取得エラー');
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (!navigator.geolocation) {
            handleLocationError('お使いのブラウザは位置情報に対応していません。');
            return;
        }

        geoTimer = setTimeout(() => {
            if (!geoAttemptCompleted) handleLocationError('応答がありませんでした（システム強制タイムアウト）。');
        }, TIMEOUT_MS);

        navigator.geolocation.getCurrentPosition(geoSuccess, geoError, {
            enableHighAccuracy: true,
            timeout: TIMEOUT_MS,
            maximumAge: 0
        });
    });
})();
</script>
{% endblock %}
