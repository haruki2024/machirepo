{% extends "top_base.html" %}

{% block title %}æŠ•ç¨¿å†…å®¹ã®ç¢ºèª{% endblock %}

{% block content %}
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    
<div class="sub-header">
    <a href="{% url "photo_post_create" %}" class="back-link">&lt; ä¿®æ­£ã™ã‚‹</a> 
    <h2 class="page-title">æŠ•ç¨¿å†…å®¹ã®ç¢ºèª</h2>
</div>
<main class="main-content list-page-main">
    <div class="form-group">
        <label>ã‚¿ã‚¤ãƒˆãƒ«</label>
        <p style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; margin:0;">{{ post_data.title|default:"(ã‚¿ã‚¤ãƒˆãƒ«ãªã—)" }}</p> 
    </div>

    <div class="form-group">
        <label>å†™çœŸ</label>
        <div class="photo-container">
            {% if post_data.photo_path %}
                <img src="/media/{{ post_data.photo_path }}" alt="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå†™çœŸ" style="max-width: 100%; height: auto; max-height: 400px; border-radius: 8px; object-fit: contain; border: 1px solid #ddd; margin-bottom: 1rem;">
            {% else %}
                å†™çœŸãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“
            {% endif %}
        </div>
    </div>

    <div class="form-group">
        <label>ä½ç½®æƒ…å ±</label> 
        {% if post_data.latitude and post_data.longitude %}
            <div id="map-display"></div>
        {% else %}
            <div style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; margin:0; line-height: 1.6;">
                {{ post_data.location_name }}
            </div>
        {% endif %}
    </div>

    <div class="form-group">
        <label>ã‚«ãƒ†ã‚´ãƒª</label>
        <p style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; margin:0;">
            {% if selected_tag %}
                <span>{{ selected_tag.name }}</span>
            {% elif post_data.tag is not None %}
                ã‚«ãƒ†ã‚´ãƒªæƒ…å ±ã«ã‚¨ãƒ©ãƒ¼
            {% else %}
                ã‚«ãƒ†ã‚´ãƒªãªã—
            {% endif %}
            
        </p>
    </div>

    <div class="form-group">
        <label>è©³ç´°</label>
        <p style="background-color: #f9fafb; padding: 0.75rem; border-radius: 0.375rem; border: 1px solid #e5e7eb; line-height: 1.6; margin:0;">{{ post_data.comment|default:"ã‚³ãƒ¡ãƒ³ãƒˆãªã—"}}</p>
    </div>

    <div class="form-submit-container">
        <form method="post" action="{% url 'photo_post_confirm' %}">
            {% csrf_token %}
            <button type="submit" class="btn btn-primary">æŠ•ç¨¿ç¢ºå®š</button>
        </form>
    </div>

</main>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // ğŸ’¡ ã‚«ã‚¹ã‚¿ãƒ ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å®šç¾©
    const customIcon = L.divIcon({
        className: 'custom-div-icon', // ä¸Šã§å®šç¾©ã—ãŸCSSã‚¯ãƒ©ã‚¹ã‚’ä½¿ç”¨
        iconSize: [15, 15],           // ã‚¢ã‚¤ã‚³ãƒ³ã‚µã‚¤ã‚º
        iconAnchor: [7.5, 7.5],       // ã‚¢ã‚¤ã‚³ãƒ³ã®ä¸­å¿ƒã«åˆã‚ã›ã‚‹
        popupAnchor: [0, -10]         // ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ä½ç½®èª¿æ•´
    });

    const lat = parseFloat("{{ post_data.latitude|default:"0" }}"); 
    const lng = parseFloat("{{ post_data.longitude|default:"0" }}");
    
    // DOMContentLoadedå¾Œã«åœ°å›³ã‚’åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
        if (lat !== 0 || lng !== 0) {
            // åœ°å›³ã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            const mapContainer = document.getElementById('map-display');
            if (mapContainer) {
                // 1. Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ
                const map = L.map('map-display').setView([lat, lng], 16); 
                
                // 2. ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’è¿½åŠ 
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
                }).addTo(map);

                // 3. ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ  - ğŸ’¡ customIconã‚’ä½¿ç”¨
                L.marker([lat, lng], {icon: customIcon}).addTo(map)
                    .bindPopup('æŠ•ç¨¿å ´æ‰€')
                    .openPopup();
                    
                // 4. ã‚µã‚¤ã‚ºã‚’å†è©•ä¾¡ (å¿µã®ãŸã‚)
                setTimeout(() => { map.invalidateSize(); }, 100);
            }
        }
    });
</script>
{% endblock %}