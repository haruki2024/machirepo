{% extends 'top_base.html' %} 

{% block title %}報告の詳細 - まちレポ管理者{% endblock %}


{% block content %}

<!-- ★追加: モーダルの表示を保証するための必須CSSスタイル★ -->
<style>
    /* .modal-overlay の必須スタイルを定義し、全画面に表示されるようにする */
    .modal-overlay {
        position: fixed; /* 画面に固定 */
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 50; /* 他の要素より前面に表示 (z-indexは十分高い値が望ましい) */
        background-color: rgba(0, 0, 0, 0.6); /* 半透明の黒背景 */
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 1rem;
    }
    /* hidden クラスがついていれば非表示にする */
    .modal-overlay.hidden {
        display: none !important; 
    }
    /* .modal-box の基本的なスタイル */
    .modal-box {
        background-color: white;
        padding: 2rem;
        border-radius: 0.5rem;
        width: 100%;
        max-width: 440px;
        box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        position: relative; /* モーダルコンテンツが前面にくるように */
    }
    /* モーダル内のボタン配置 */
    .modal-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }
</style>


<div class="p-4 md:p-8">
    <div class="page-container">

        <header class="app-header">
            <div class="title">まちレポ 管理者ページ</div>
            <!-- ログアウトリンク (urls.pyの'logout'を使用) -->
            <a href="{% url 'logout' %}" class="header-link">ログアウト</a>
        </header>
        
        <main class="main-content">
            <a href="{% url 'admin_post_list' %}" class="link-secondary" style="margin: 0 0 1.5rem 0; text-align: left;"> &lt; 管理メニューに戻る
            </a>

            <!-- 報告タイトル (視認性向上のため追加) -->
            <h1 class="text-3xl font-bold text-gray-900 mb-6">報告詳細</h1>
            

            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-1">タイトル:</label>
                <p class="bg-gray-50 p-3 border border-gray-300 rounded-md whitespace-pre-wrap">{{ post.title|default:"(タイトルなし)" }}</p>
                
            </div>

            
            <!-- 写真 -->
            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-2">写真:</label>
                <div class="bg-gray-200 rounded-md overflow-hidden border border-gray-300 h-64">
                    {% if post.photo %}
                        <img src="{{ post.photo.url }}" alt="報告写真: {{ post.title }}" class="post-photo">
                    {% else %}
                        <div class="w-full h-full flex items-center justify-center text-gray-500">
                            写真がありません
                        </div>
                    {% endif %}
                </div>
                
            </div>


            <!-- 場所 (テキスト情報のみ) -->
            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-2">場所:</label>
                <!-- 元のHTMLに合わせて背景やボーダーはそのまま残します。 -->
                <div class="bg-gray-50 rounded-md border border-gray-300 p-3">
                    <p class="text-gray-800">
                        {% if post.location_name %}
                            {{ post.location_name }}
                        {% elif post.latitude and post.longitude %}
                            緯度: {{ post.latitude }}, 経度: {{ post.longitude }}
                        {% else %}
                            位置情報は記録されていません
                        {% endif %}
                    </p>
                </div>
            </div>

            <!-- カテゴリ -->
            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-1">カテゴリ:</label>
                <p class="text-gray-800">
                    {% for tag in post.tags.all %}
                        <span class="inline-block bg-indigo-100 text-indigo-700 text-sm px-2 py-0.5 rounded-full mr-1">{{ tag.name }}</span>
                    {% endfor %}
                </p>
            </div>

            <!-- 詳細 -->
            <div class="form-group mb-6">
                <label class="block text-gray-700 font-medium mb-1">詳細:</label>
                <p class="bg-gray-50 p-3 border border-gray-300 rounded-md whitespace-pre-wrap">{{ post.comment }}</p>
            </div>
            
            <!-- 管理者メモ/対応内容 -->
            {% if post.admin_note %}
            <div class="form-group mb-6 p-3 bg-indigo-50 border border-indigo-200 rounded-md">
                <label class="block text-indigo-700 font-medium mb-1">管理者メモ/対応内容:</label>
                <p class="text-indigo-800 whitespace-pre-wrap">{{ post.admin_note }}</p>
            </div>
            {% endif %}

        

            <!-- アクションボタン -->
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-4 mt-8 pt-6 border-t border-gray-200">
                <!-- ステータス編集ボタン (btn-primary クラスに依存) -->
                <a href="{% url 'admin_post_status_edit' post_id=post.id %}" class="btn btn-primary flex-1 text-center py-3 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-semibold transition duration-150">
                    ステータスを記録する
                </a>
                
                <!-- 報告削除ボタン (btn-danger クラスに依存) -->
                <button type="button" onclick="openDeleteModal('{% if post.title %}{{ post.title|escapejs }}{% else %}タイトルなし{% endif %}')" class="btn btn-secondary" style="border: 1px solid #ef4444; color: #ef4444;">
                    この報告を削除する
                </button>
            </div>

        

        </main>

        <!-- モーダル本体 -->
        <div id="delete-modal" class="modal-overlay hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
            <div class="modal-box">
            
                
                <!-- タイトル -->
                <h2 class="text-2xl font-extrabold text-red-700 mb-4" id="modal-title">本当に削除しますか？</h2>
                
                <p class="text-sm text-gray-600 mb-6 border-b pb-4">
                    この操作は取り消せません。                
                </p>
                

                
                <div class="modal-actions">
                    <!-- キャンセルボタン -->
                    <button type="button" onclick="closeDeleteModal()" class="btn btn-secondary" style="flex: 1; margin-top: 0;">
                        キャンセル
                    </button>
                    
                    <form id="deleteForm" method="post" action="{% url 'admin_post_delete' post_id=post.pk %}" style="display: inline; flex: 1;">
                        {% csrf_token %}
                        <!-- 削除ボタン -->
                        <button type="submit" class="btn btn-danger" style="width: 100%;">
                            削除
                        </button>
                    </form>
                </div>
                
            </div>
        </div>

    </div>
 
</div>


<script>
    const deleteModal = document.getElementById('delete-modal');
    const postTitlePlaceholder = document.getElementById('postTitlePlaceholder');

    /**
     * 削除確認モーダルを表示し、報告タイトルをセットする関数。
     */
    function openDeleteModal(postTitle) {
        if (postTitlePlaceholder) {
            postTitlePlaceholder.textContent = postTitle;
        }
        
        if (deleteModal) {
            deleteModal.classList.remove('hidden');
            console.log("Delete Modal opened successfully."); 
        } else {
            console.error("Delete Modal element not found! Check HTML ID."); 
        }
    }

    /**
     * 削除確認モーダルを閉じる関数。
     */
    function closeDeleteModal() {
        if (deleteModal) {
            deleteModal.classList.add('hidden');
            console.log("Delete Modal closed."); 
        }
    }
    
    // 互換性のため、closeModalをcloseDeleteModalにマップ
    function closeModal() {
        closeDeleteModal();
    }


    // モーダル背景クリックでモーダルを閉じる機能
    if (deleteModal) {
        deleteModal.addEventListener('click', function(event) {
            // イベントターゲットがdeleteModal自身（オーバーレイ）であるかチェック
            if (event.target === deleteModal) {
                closeDeleteModal();
            }
        });
    }
</script>





{% endblock %}
